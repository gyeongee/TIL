#OPEN AI에서 데이터 추출
import requests
import pandas as pd

# ------------------------------
# 1. API URL 및 파라미터
# ------------------------------
url = "https://www.safe182.go.kr/api/lcm/amberList.do"

authKey = ""
esntId = ""

payload = {
    "esntlId": esntlId,
    "authKey": authKey,
    "rowSize": "100",
    "page": "1",
    "sexdstnDscd": "",
    "nm": "",
    "detailDate1": "",
    "detailDate2": "",
    "age1": "",
    "age2": "",
    "occrAdres": "",
    "xmlUseYN": "N"
}

# 대상 구분 배열 파라미터
writngTrgetDscds = ["010", "060", "070"]  # "010" → 아동, "060" → 치매노인, "070" → 지적장애인

# ------------------------------
# 2. 모든 페이지 데이터 수집
# ------------------------------
all_items = []
page = 1

while True:
    # payload 복사
    data = payload.copy()
    data["page"] = str(page)

    # 배열 파라미터 반복 전송
    for val in writngTrgetDscds:
        data.setdefault("writngTrgetDscds", [])
        data["writngTrgetDscds"].append(val)

    # headers
    headers = {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}

    # POST 요청
    response = requests.post(url, data=data, headers=headers)

    # JSON 변환
    try:
        data_json = response.json()
    except ValueError:
        print(f"JSON 변환 실패: page {page}")
        break

    items = data_json.get("list", [])
    if not items:
        break  # 데이터 없으면 종료

    all_items.extend(items)
    print(f"page {page} -> {len(items)}개 추가")

    total_count = int(data_json.get("totalCount", 0))
    if page * int(payload["rowSize"]) >= total_count:
        break  # 마지막 페이지 도달
    page += 1

# ------------------------------
# 3. DataFrame 변환 및 CSV 저장
# ------------------------------
df = pd.DataFrame(all_items)
df.to_csv('./data/안전드림_실종경보.csv', index=False, encoding='utf-8-sig')
print(f"총 {len(df)}개 데이터 CSV 저장 완료")